var busy,data,dye,finish,frame,graph,hide,image_prefix,index,load_context,map,mapper,onloads,pending_tasks,receive,show,spinner,stage,toggle,_get,_onload,__slice=[].slice;_get=this._get=function $this$_get$($d$$){if($d$$&&null!=$d$$.querySelector)return $d$$;if("string"===typeof $d$$)return"#"===$d$$[0]?document.getElementById($d$$.replace("#","")):document.querySelectorAll($d$$);console.log("_get was asked to retrieve:",$d$$);throw"invalid _get string";};
show=this.show=function $this$show$($d$$,$hidden_only$$){var $el$$,$element$$,$_i$$,$_len$$,$_results$$;$el$$=_get($d$$);null==$el$$.length&&($el$$=[$el$$]);$_results$$=[];$_i$$=0;for($_len$$=$el$$.length;$_i$$<$_len$$;$_i$$++)$element$$=$el$$[$_i$$],$hidden_only$$?$_results$$.push($element$$.classList.remove("hidden")):$_results$$.push($element$$.classList.remove("transparent"));return $_results$$};
hide=this.hide=function $this$hide$($d$$2_el$$){var $element$$,$_i$$,$_len$$,$_results$$;$d$$2_el$$=_get($d$$2_el$$);null==$d$$2_el$$.length&&($d$$2_el$$=[$d$$2_el$$]);$_results$$=[];$_i$$=0;for($_len$$=$d$$2_el$$.length;$_i$$<$_len$$;$_i$$++)$element$$=$d$$2_el$$[$_i$$],$_results$$.push($element$$.classList.add("transparent"));return $_results$$};
toggle=this.toggle=function $this$toggle$($d$$,$klass$$){var $el$$,$element$$,$_i$$,$_len$$,$_results$$;$el$$=_get($d$$);null==$el$$.length&&($el$$=[$el$$]);$_results$$=[];$_i$$=0;for($_len$$=$el$$.length;$_i$$<$_len$$;$_i$$++)$element$$=$el$$[$_i$$],$_results$$.push($element$$.classList.toggle($klass$$||"transparent"));return $_results$$};
dye=this.dye=function $this$dye$($d$$,$color$$){var $el$$,$element$$,$_i$$,$_len$$,$_results$$;$el$$=_get($d$$);null==$el$$.length&&($el$$=[$el$$]);$_results$$=[];$_i$$=0;for($_len$$=$el$$.length;$_i$$<$_len$$;$_i$$++)$element$$=$el$$[$_i$$],$_results$$.push($element$$.style.setProperty("background-color",$color$$));return $_results$$};busy=this.busy=function $this$busy$(){if(0===this.pending_tasks++)return show(this.spinner)};finish=this.finish=function $this$finish$(){if(0===--this.pending_tasks)return hide(this.spinner)};
pending_tasks=this.pending_tasks=1;spinner=this.spinner=_get("#appspinner");stage=this.stage=_get("#appstage");map=this.map=_get("#map");mapper=this.mapper=_get("#mapper");frame=this.frame=_get("#appframe");image_prefix=this.image_prefix="//deliver.fcm-static.org/image-proxy/providence-clarity/warehouse/raw/govtrack/photos/";onloads=this.__onload_callbacks=[];data=this.data={};index=this.index={adjacency:{},nodes_by_key:{},edges_by_key:{},natives_by_key:{},object_natives:{}};
graph=this.graph={nodes:[],edges:[],natives:[]};
receive=this.receive=function $this$receive$($data$$){var $key$$,$_key_iter__len1__ref1$$,$payload$$,$_len$$,$_ref$$,$_i$$4__j__ref2$$,$_k$$,$_len2$$;$payload$$="string"===typeof $data$$?this.payload=JSON.parse($data$$):this.payload=$data$$;$_ref$$=$payload$$.data.keys;$_key_iter__len1__ref1$$=$_i$$4__j__ref2$$=0;for($_len$$=$_ref$$.length;$_i$$4__j__ref2$$<$_len$$;$_key_iter__len1__ref1$$=++$_i$$4__j__ref2$$)$key$$=$_ref$$[$_key_iter__len1__ref1$$],null==this.data[$key$$]&&(this.data[$key$$]=$payload$$.data.objects[$_key_iter__len1__ref1$$]);
$_key_iter__len1__ref1$$=Array($payload$$.graph.natives);$key$$=$_i$$4__j__ref2$$=0;for($_key_iter__len1__ref1$$=$_key_iter__len1__ref1$$.length;$_i$$4__j__ref2$$<$_key_iter__len1__ref1$$;$key$$=++$_i$$4__j__ref2$$)$key$$=$payload$$.graph.edges+1+$key$$,null==index.natives_by_key[$payload$$.data.keys[$key$$]]&&(index.natives_by_key[$payload$$.data.keys[$key$$]]=graph.natives.push({key:$payload$$.data.keys[$key$$],data:$data$$[$payload$$.data.keys[$key$$]]})-1);for($_key_iter__len1__ref1$$=-1;$_key_iter__len1__ref1$$<
$payload$$.data.keys.length;)if($_key_iter__len1__ref1$$++,$_key_iter__len1__ref1$$<=$payload$$.graph.nodes)this.index.nodes_by_key[$payload$$.data.keys[$_key_iter__len1__ref1$$]]||($_i$$4__j__ref2$$=index.nodes_by_key[$payload$$.data.keys[$_key_iter__len1__ref1$$]]=graph.nodes.push({node:{key:$payload$$.data.keys[$_key_iter__len1__ref1$$],data:this.data[$payload$$.data.keys[$_key_iter__len1__ref1$$]]},"native":{key:$payload$$.data.objects[$_key_iter__len1__ref1$$]["native"],data:this.data[$payload$$.data.objects[$_key_iter__len1__ref1$$]["native"]]}})-
1),$_i$$4__j__ref2$$=index.nodes_by_key[$payload$$.data.keys[$_key_iter__len1__ref1$$]];else if($_key_iter__len1__ref1$$<=$payload$$.graph.edges)for(index.edges_by_key[$payload$$.data.keys[$_key_iter__len1__ref1$$]]||(index.edges_by_key[$payload$$.data.keys[$_key_iter__len1__ref1$$]]=[]),$_i$$4__j__ref2$$=$payload$$.data.objects[$_key_iter__len1__ref1$$].node,$key$$=$_i$$4__j__ref2$$[0],$_ref$$=2<=$_i$$4__j__ref2$$.length?__slice.call($_i$$4__j__ref2$$,1):[],$_k$$=0,$_len2$$=$_ref$$.length;$_k$$<
$_len2$$;$_k$$++)$_len$$=$_ref$$[$_k$$],this.index.adjacency[$key$$]&&this.index.adjacency[$key$$][$_len$$]?$_i$$4__j__ref2$$=this.index.adjacency[$key$$][$_len$$]:($_i$$4__j__ref2$$=graph.edges.push({edge:{key:$payload$$.data.keys[$_key_iter__len1__ref1$$],data:$data$$[$payload$$.data.keys[$_key_iter__len1__ref1$$]]},"native":$data$$[$payload$$.data.objects[$_key_iter__len1__ref1$$]["native"]],source:{index:index.nodes_by_key[$key$$],object:graph.nodes[index.nodes_by_key[$key$$]]},target:{index:index.nodes_by_key[$_len$$],
object:graph.nodes[index.nodes_by_key[$_len$$]]}})-1,index.edges_by_key[$payload$$.data.keys[$_key_iter__len1__ref1$$]].push($_i$$4__j__ref2$$),null==this.index.adjacency[$key$$]&&(this.index.adjacency[$key$$]={}),this.index.adjacency[$key$$][$_len$$]=$_i$$4__j__ref2$$);return setTimeout(function(){return this.draw(graph)},0)};
load_context=this.load_context=function $this$load_context$($event$$,$data$$){var $_mapper_reveal_context_pagedata$$,$_mapper_queue$$,$_show_queue$$,$_ui_reveal$$;$_show_queue$$=[];$_mapper_queue$$=[];$_mapper_reveal_context_pagedata$$=this.context=$data$$||JSON.parse(document.getElementById("js-context").textContent);console.log("Loading context...",$_mapper_reveal_context_pagedata$$);this.context.services&&(console.log("Loading services...",$_mapper_reveal_context_pagedata$$.services),apptools.rpc.service.factory($_mapper_reveal_context_pagedata$$.services));
this.context.pagedata&&($_mapper_reveal_context_pagedata$$=this.pagedata=JSON.parse(document.getElementById("js-data").textContent),console.log("Detected stapled pagedata...",$_mapper_reveal_context_pagedata$$),this.receive($_mapper_reveal_context_pagedata$$));this.context.session&&(this.context.session.established?(this.session=this.context.session.payload,console.log("Loading existing session...",this.session)):(this.session={authenticated:!1},console.log("Establishing fresh session...",this.session),
$_show_queue$$.push(this._get("#logon"))));$_show_queue$$.push(this._get("#appfooter"));$_show_queue$$.push(this._get("#map"));$_mapper_queue$$.push(this._get("#catnip"));$_ui_reveal$$=function($_this$$){return function(){var $element_set$$,$_i$$,$_len$$,$_results$$;console.log("Flushing UI reveal queue...",$_show_queue$$);$_results$$=[];$_i$$=0;for($_len$$=$_show_queue$$.length;$_i$$<$_len$$;$_i$$++)$element_set$$=$_show_queue$$[$_i$$],$_results$$.push($_this$$.show($element_set$$));return $_results$$}}(this);
$_mapper_reveal_context_pagedata$$=function($_this$$){return function(){var $element_set$$,$_i$$,$_len$$;console.log("Flusing mapper reveal queue...",$_mapper_queue$$);$_i$$=0;for($_len$$=$_mapper_queue$$.length;$_i$$<$_len$$;$_i$$++)$element_set$$=$_mapper_queue$$[$_i$$],$_this$$.show($element_set$$);return $_this$$.finish()}}(this);setTimeout($_ui_reveal$$,800);setTimeout($_mapper_reveal_context_pagedata$$,500);return this.context};onloads.push(load_context);
_onload=this.onload=function $this$onload$($event$$){var $callback$$,$_i$$,$_len$$,$_ref$$,$_results$$;$_ref$$=this.__onload_callbacks;$_results$$=[];$_i$$=0;for($_len$$=$_ref$$.length;$_i$$<$_len$$;$_i$$++)$callback$$=$_ref$$[$_i$$],$_results$$.push($callback$$($event$$));return $_results$$};var browse,catnip,draw,graph_config,_ref,_ref1,_ref2;catnip=this.catnip={};
graph_config=this.graph_config={width:this.mapper.offsetWidth,height:this.mapper.offsetHeight,force:{alpha:1,strength:0.4,friction:0.5,theta:0.3,gravity:0.05,charge:-50,distance:function $this$graph_config$force$distance$($e$$){var $_ref$$;return null!=(null!=($_ref$$=$e$$["native"])?$_ref$$.data:void 0)?$e$$["native"].data.total:500}},node:{radius:20},sprite:{width:60,height:60,images:{format:(null!=(_ref=this.context)?null!=(_ref1=_ref.agent)?null!=(_ref2=_ref1.capabilities)?"function"===typeof _ref2.webp?
_ref2.webp({webp:"jpeg"}):void 0:void 0:void 0:void 0)||"jpeg"}},events:{click:{warmup:0.4}}};browse=this.browse=function $this$browse$($node$$){console.log("Browsing to origin...",$node$$);return $.apptools.api.graph.construct({origin:$node$$.node.key}).fulfill({success:function($response$$){return receive($response$$)}})};
draw=this.draw=function $this$draw$($_graph__graph_draw__incremental_draw$$){var $config$$,$force$$,$_load$$;if(null==this.catnip.graph)return this.catnip.graph=$_graph__graph_draw__incremental_draw$$,$config$$=this.graph_config,this.d3.scale.category20(),$force$$=this.catnip.force=this.d3.layout.force().linkDistance($config$$.force.distance).linkStrength($config$$.force.strength).friction($config$$.force.friction).charge($config$$.force.charge).theta($config$$.force.theta).gravity($config$$.force.gravity).alpha($config$$.force.alpha).size([$config$$.width,
$config$$.height]),$_load$$=function $$_load$$$($g$$){var $container$$,$edge_edge_wrap$$,$line$$,$node$$;$node$$=this.catnip.svg=this.d3.select(this.map);$edge_edge_wrap$$=this.catnip.edge_wrap=$node$$.selectAll(".edge").data($g$$.edges).enter();$edge_edge_wrap$$=this.catnip.edge=$edge_edge_wrap$$.append("svg").attr("id",function($e$$){return"edge-"+$e$$.edge.key});$line$$=this.catnip.line=$edge_edge_wrap$$.append("line").attr("stroke","#999").attr("class","link").style("stroke-width",2);$node$$=
this.catnip.node_wrap=$node$$.selectAll(".node").data($g$$.nodes).enter();$container$$=this.catnip.node_container=$node$$.append("svg").attr("id",function($n$$){return"group-"+$n$$.node.key}).attr("width",$config$$.sprite.width).attr("height",$config$$.sprite.height).call($force$$.drag).on("dblclick",browse);$node$$=this.catnip.node=$container$$.append("g").attr("width",$config$$.sprite.width).attr("height",$config$$.sprite.height);this.catnip.circle=$node$$.append("circle").attr("r",$config$$.node.radius).attr("cx",
$config$$.sprite.width/2).attr("cy",$config$$.sprite.height/2).attr("class","node");this.catnip.legislator_image=$node$$.append("image").filter(function($n$$){return null!=$n$$["native"].data.govtrack_id}).attr("width",$config$$.sprite.width).attr("height",$config$$.sprite.height).attr("clip-path","url(#node-circle-mask)").attr("xlink:href",function($n$$){return image_prefix+$n$$["native"].data.govtrack_id.toString()+"-100px."+$config$$.sprite.images.format});$force$$.on("tick",function($f$$){$line$$.attr("x1",
function($d$$){return $d$$.source.object.x+$config$$.node.radius/2}).attr("y1",function($d$$){return $d$$.source.object.y+$config$$.node.radius/2}).attr("x2",function($d$$){return $d$$.target.object.x+$config$$.node.radius/2}).attr("y2",function($d$$){return $d$$.target.object.y+$config$$.node.radius/2});return $container$$.attr("x",function($d$$){return $d$$.x-$config$$.node.radius}).attr("y",function($d$$){return $d$$.y-$config$$.node.radius})});return $force$$.nodes($g$$.nodes).links($g$$.edges).start()},
console.log("Drawing graph...",$_graph__graph_draw__incremental_draw$$),$_graph__graph_draw__incremental_draw$$=function($_this$$){return function(){return $_load$$(graph)}}(this),setTimeout($_graph__graph_draw__incremental_draw$$,150);console.log("Incremental draw...",graph);$_graph__graph_draw__incremental_draw$$=function($_this$$){return function(){$_this$$.catnip={};$_this$$.hide($_this$$.map);$_this$$.map.textContent="";$_this$$.draw(graph);return setTimeout(function(){return $_this$$.show($_this$$.map)},
250)}}(this);return setTimeout($_graph__graph_draw__incremental_draw$$,0)};
