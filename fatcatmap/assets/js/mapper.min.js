var browse,configure,detail,draw;
configure=function(){var a;a={width:this.catnip.el.mapper.offsetWidth,height:this.catnip.el.mapper.offsetHeight,force:{alpha:.75,strength:1,friction:.9,theta:.7,gravity:.1,charge:-700,distance:150},origin:{snap:!0,dynamic:!0,position:{x:this.catnip.el.mapper.offsetWidth-30,y:this.catnip.el.mapper.offsetHeight-30}},node:{radius:20,classes:"node"},labels:{enable:!1,distance:0},edge:{width:2,stroke:"#999",classes:"link"},sprite:{width:60,height:60,images:{format:this.catnip.context.agent.capabilities.webp&&"webp"||
"jpeg"}}};return this.catnip.config.graph=a};
detail=this.detail=this.catnip.graph.detail=function(a){var e,b,h,l;null!=a["native"].data.firstname&&(e=$.apptools.templates.get("tpl-legislator").render({key:a.node.key,"class":"node-detail",firstname:a["native"].data.firstname,lastname:a["native"].data.lastname,office:"H"===(null!=(b=a["native"].data.fecid)?b[0]:void 0)&&"Representative"||"Senator",title:"H"===(null!=(h=a["native"].data.fecid)?h[0]:void 0)&&"Rep"||"Sen",state:null!=(l=a["native"].data.fecid)?l.slice(2,4):void 0,govtrack_id:a["native"].data.govtrack_id,
image_format:$.catnip.config.graph.sprite.images.format,portrait_size:"200px",config:$.catnip.config}),$("#leftbar section.content").html(e));console.log("Showing detail for node...",a,e);if($.catnip.el.leftbar.classList.contains("collapsed"))return $.catnip.ui.expand($.catnip.el.leftbar)};browse=this.browse=this.catnip.graph.browse=function(a){console.log("Browsing to origin...",a);return $.apptools.api.graph.construct({origin:a.node.key}).fulfill({success:function(a){return receive(a)}})};
draw=this.draw=this.catnip.graph.draw=function(a){return function(e){var b,h,l,w;console.log("Drawing materialized graph.",e);if(null==a.catnip.graph.active)return a.catnip.config.graph=configure(),a.catnip.graph.active=e,b=a.catnip.config.graph,a.d3.scale.category20(),h=a.catnip.graph.force=a.d3.layout.force().size([b.width,b.height]).linkDistance(b.force.distance).charge(b.force.charge).linkStrength(b.force.strength).friction(b.force.friction).theta(b.force.theta).gravity(b.force.gravity).alpha(b.force.alpha),
w=function(){var a,d;d=this.innerWidth||document.body.clientWidth||document.documentElement.clientWidth;a=this.innerHeight||document.body.clientHeight||document.documentElement.clientHeight;this.catnip.config.graph.width=d;this.catnip.config.graph.height=a;this.catnip.graph.root.attr("width",d).attr("height",a);return this.catnip.graph.force.size([b.width,b.height]).resume()},l=function(a,d,l){var t,u,x,y,z,n,m,r,k,f,p,c,q,v,s;n=this.catnip.graph.root=this.d3.select(this.map);if(b.labels.enable){q=
[];r=[];v=a.nodes;k=0;for(p=v.length;k<p;k++)c=v[k],f=[],null!=c["native"].data.fecid||null!=c["native"].data.govtrack_id?null!=c["native"].data.fecid?(m=!1,"H"===c["native"].data.fecid[0]?(f.push("Rep."),m=!0):"S"===c["native"].data.fecid[0]?f.push("Sen."):"P"===c["native"].data.fecid[0]&&f.push("President"),f.push(c["native"].data.firstname),f.push(c["native"].data.lastname),s=c["native"].data.fecid.slice(2,4),m&&(s+="-"+c["native"].data.fecid.slice(4,6)),f.push("["+s+"]"),q.push({node:c,label:f.join(" ")})):
(console.warn("Missing FECID for Legislator node.",c),q.push({node:c,label:""})):null!=c["native"].data.contributor_type?q.push({node:c,label:c["native"].data.name}):console.error("Unidentified object.",c);p=a.edges;k=0;for(f=p.length;k<f;k++)m=p[k],r.push({edge:m,label:"contribution",source:m.source,target:m.target});u=this.catnip.graph.label_force=this.d3.layout.force().nodes(q).links(r).gravity(0).linkDistance(0).linkStrength(8).charge(-100).size([d,l])}d=this.catnip.graph.edge_wrap=n.selectAll(".edge").data(a.edges).enter();
d=this.catnip.graph.edge=d.append("svg:svg").attr("id",function(b){return"edge-"+b.edge.key});x=this.catnip.graph.line=d.append("svg:line").attr("stroke",b.edge.stroke).attr("class",b.edge.classes).style("stroke-width",b.edge.width);d=this.catnip.graph.node_wrap=n.selectAll(".node").data(a.nodes).enter();t=this.catnip.graph.node_container=d.append("svg:svg").attr("id",function(b){return"group-"+b.node.key}).attr("width",b.sprite.width).attr("height",b.sprite.height).on("dblclick",this.catnip.graph.browse).on("click",
this.catnip.graph.detail).call(h.drag);d=this.catnip.graph.node=t.append("svg:g").attr("width",b.sprite.width).attr("height",b.sprite.height).attr("class",function(b,a){var g;g=["node-group"];null!=b["native"].data.govtrack_id?(g.push("legislator"),g.push("M"===b["native"].data.gender&&"male"||"female"),g.push(parseInt(100*Math.random()%2)&&"democrat"||"republican")):(g.push("contributor"),g.push("C"===b["native"].data.contributor_type&&"corporate"||"individual"));return g.join(" ")});this.catnip.graph.circle=
d.append("svg:circle").attr("r",b.node.radius).attr("cx",b.sprite.width/2).attr("cy",b.sprite.height/2).attr("class",b.node.classes);this.catnip.graph.legislator_image=d.append("svg:image").filter(function(b){return null!=b["native"].data.govtrack_id}).attr("width",b.sprite.width).attr("height",b.sprite.height).attr("clip-path","url(#node-circle-mask)").attr("xlink:href",function(a){return function(A){return a.catnip.config.assets.prefix+"image-proxy/providence-clarity/warehouse/raw/govtrack/photos/"+
A["native"].data.govtrack_id.toString()+"-"+(a.catnip.context.agent.capabilities.retina&&"200px"||"100px")+"."+b.sprite.images.format}}(this));b.labels.enable&&(n.selectAll(".ghost-edge.label").data(r),n.selectAll(".ghost-node.label").data(u.nodes()).enter().append("svg:g").attr("id",function(b,a){return"anchor-"+b.node.node.key}).attr("class","anchor-node").append("svg:circle").attr("r",0).style("fill","#FFF").append("svg:text").text(function(b,a){return b.label||""}).style("fill","#555").style("font-family",
"Arial").style("font-size",12));window.onresize=w;y=function(a){return function(a,g,c,d){return b.origin.snap&&c[a].index===e.origin?Math.floor(b.origin.position[g]):Math.floor(c[a][g]+b.node.radius/2)}}(this);z=function(a){return function(a,c,d){return b.origin.snap&&d===e.origin?Math.floor(b.origin.position[a]-b.sprite["x"===a&&"width"||"height"]/2):Math.floor(c[a]-b.node.radius)}}(this);h.on("tick",function(a){return function(a){var c,d,e,f;a=b.width/2;c=b.height/2;b.origin.dynamic&&b.origin.snap&&
(b.origin.position={x:a+b.sprite.width/2,y:c+b.sprite.height/2});b.labels.enable&&u.start();e=["x","y"];a=0;for(c=e.length;a<c;a++)d=e[a],t.attr(d,function(a,b){return z(d,a,b)});e=["x1","y1","x2","y2"];f=[];a=0;for(c=e.length;a<c;a++)d=e[a],f.push(x.attr(d,function(a,b){return y("1"===d[1]&&"source"||"target",d[0],a,b)}));return f}}(this));return h.nodes(a.nodes).links(a.edges).start()||h},console.log("Drawing graph...",e),setTimeout(function(){return l(e)},150);console.log("Incremental draw...",
e);return setTimeout(function(){a.catnip.ui.hide(a.map);a.catnip.el.map.textContent="";a.catnip.graph.draw(e);return setTimeout(function(){return a.catnip.ui.show(a.map)},250)},0)}}(this);
